# Генерция объектной программы по обратной польской записи
Для генерации используем стек операндов - SO.
Элементы стека - SO[i]. Изначально i0 = 1.
Рабочие переменные: R[j]. j0 = 1.


## Алгоритм генерации команд.

1. Взять очередной символ S из обратной польской записи. Если символов нет, то выход.
2. Если S - операнд, то он помечается в стек, т.е. SO[i] = S; i++; GOTO 1
3. S - операция. Будем считать, что у неё `m` операндов, которые порождают результат или нет.
   Среди этих m верхних символов стека находим рабочую переменную R[j] с минимальным номером, например №l.
   Её будем использовать для размещения результата.
   Если рабочих переменных нет, то принимает l=j.
4. Генерируем машинные команды, реализующие S.
   Если S порождает результат, то в этих командах результат помещается в R[l].
5. Вычёркиваем операнды из стека, т.е. `i-=m`. Корректируем j: `j=l`.
   Если S порождает результат, то в стек помещается `R[l]` и увеличивается `j`: `j++`.
6. GOTO 1


Пример:
```
a = (b + c) * (d + e * f)
a b c + d e f * + * =
```
Предположим, что система команд компьютера состоит из трёх операций:
1. `add oper1, oper2, result` - сложение.
2. `mlt oper1, oper2, result` - умножение.
3. `asg oper1, oper2` - пересылка.

`a b c + d e f * + * =`

| S | SO           | i | j | команды           |
|:-:|:-------------|:-:|:-:|:------------------|
| a | a            | 2 |   |                   |
| b | ab           | 3 |   |                   |
| c | abc          | 4 |   |                   |
| + | a R1         | 3 | 2 | add b, c, R[1]    |
| d | a R1 d       | 4 | 2 |                   |
| e | a R1 d e     | 5 | 2 |                   |
| f | a R1 d e f   | 6 | 2 |                   |
| * | a R1 d R2    | 5 | 3 | mult e, f, R2     |
| + | a R1 R2      | 4 | 3 | add d, R2, R2     |
| * | a R1         | 3 | 2 | mult R1, R2, R1   |
| = | -            | 1 | 1 | asg a, r1         |



## Генерация команд перехода в обратной польской записи

Одна из проблем - это определени адресов меток, на которые выполняются переходы.
При генерации машинных команд по УПЛ и БП необходимо в код программы перехода поместить адрес метки, однакоэто невозможно, т.к. расположение меток ещё неизвестно.

При формировании машинных программ зааполняем таблицу меток по двоеточию и таблицу недостроенных команд.
По концу генерации просматриваем таблицу недостроенных команд. В таблице меток находим адреса и достраиваем.
| метка | адрес |
|:-----:|:------|
|       |       |

| адрес | метка |
|:-----:|:------|
|       |       |

Предположим, что система команд компьютера состоит ещё из трёх операций:
1. `sub oper1, oper2, result` - вычитание
2. `jump mark` - безусловный переход по ккакой-то метке.
3. `jm oper, mark` - переход по минусу.

Пример
```
a b <= m1 УПЛ
    b c = m2 БП
    m1: a b c * =
m2:
```
Предположим машинные команды распологаются в памяти с адреса 1000 и каждая команда занимает 4 байта.
| S | SO           | i | j | команды                         | метки | команды |
|:-:|:-------------|:-:|:-:|:--------------------------------|-------|---------|
| a | a            | 2 | 1 |                                 |       |         |
| b | a b          | 3 | 1 |                                 |       |         |
|<= | R1           | 2 | 2 | 1000 sub b, a, R1               |       |         |
|m1 | R1 m1        | 3 | 2 |                                 |       |         |
|УПЛ|              | 1 | 1 | 1004 ПМ R1, `1004`              |       | 1004,m1 |
| b | b            | 2 | 1 |                                 |       |         |
| c | b c          | 3 | 1 |                                 |       |         |
| = |              | 1 | 1 | 1008 asg b, c                   |       |         |
|m2 | m2           |   |   |                                 |       |         |
| БП|              |   |   | 1012 БП,`1024`                  |       | 1012,m2 |
|m1 |m1            | 2 | 1 |                                 |       |         |
| : | -            | 1 | 1 |                                 |m1,1016|         |
| a | a            |   |   |                                 |       |         |
| b | a b          |   |   |                                 |       |         |
| c | a b c        |   |   |                                 |       |         |
| * | a R1         | 2 | 2 | 1016 mult b, c, R1              |       |         |
| = |              | 1 | 1 | 1020 asgn a, R1                 |       |         |
|m2 |              | 2 |   |                                 |       |         |
| : |              | 1 |   |                                 |m2,1024|         |

П.с. z<0 можно превратить в 0 или 1 так:
```
выч z, 0, R1
ПМ R1 m1
ПЕР R1, 0
БП m2
m1: Пер R1, 1
m2:
```

ИЛИ - это
```
add R1, R2, R1
ПН R1, m1
...
m1:
```
